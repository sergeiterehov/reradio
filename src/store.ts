import { createStore } from "zustand";
import { RB618Radio } from "./drivers/radtel_t18";
import type { Radio } from "./drivers/radio";
import { Buffer } from "buffer";

export type Store = {
  radio?: Radio;
  task?: string;
  progress?: number;

  _actions: {
    init: () => void;
    download: () => void;
    upload: () => void;
  };
};

export const Store = createStore<Store>((set, get) => {
  const _handleProgress = (k: number) => set({ progress: k });

  const _clearTask = () => set({ task: undefined, progress: undefined });

  const _actions: Store["_actions"] = {
    init: () => {
      const { radio = new RB618Radio() } = get();
      set({ radio });

      // FIXME: REMOVE sample
      radio.load(
        Buffer.from(
          "002542450025424593069306e3ffffff00254345002543450010001009ffffff00254445002544451415141509ffffff00254545002545453520352009ffffff00254645002546451824182409ffffff00254745002547452380238009ffffff00254845002548451481148109ffffff00254945002549450582058209ffffff00255145002551450683068309ffffff00255245002552451184118409ffffff00255345002553450385038509ffffff00255445002554450686068609ffffff00255545002555455487548709ffffff0025214000252140ffffffff09ffffff0050554300505543ffffffff09ffffff0050894600508946ffffffff09ffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000010101ffffffffffffffff0302000601ffffffffffffffffffffff0000f73331303350ffffffffffffffff",
          "hex"
        )
      );
    },

    download: async () => {
      const { radio } = get();

      if (!radio) return;

      set({ task: "Downloading" });
      try {
        await radio.connect();
        await radio.read(_handleProgress);
        await radio.disconnect();
      } finally {
        _clearTask();
      }
    },

    upload: async () => {
      const { radio } = get();

      if (!radio) return;

      set({ task: "Uploading" });
      try {
        await radio.connect();
        await radio.write(_handleProgress);
        await radio.disconnect();
      } finally {
        _clearTask();
      }
    },
  };

  return {
    _actions,
  };
});
export const Actions = Store.getState()._actions;

Actions.init();
